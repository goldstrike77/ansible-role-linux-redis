---
- name: Include tasks for specific OS
  include: '{{ ansible_os_family }}.yml'

- name: Include firewall tasks
  include: 'firewall.yml'

- name: Straight to getenforce selinux status
  include: 'selinux.yml'

- name: Creating Redis folder
  file:
    dest: '{{ redis_path }}/redis'
    state: 'directory'
    owner: 'redis'
    group: 'redis'
    mode: '0755'

- name: Redis Server Configuration
  lineinfile:
    state: 'present'
    dest: '/etc/redis.conf'
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  loop: '{{ redis_server_parameters }}'
  register: conf_update
  no_log: true

- name: Rename an unsafe redis command
  lineinfile:
    state: 'present'
    dest: '/etc/redis.conf'
    regexp: '^rename-command {{ item }}'
    line: 'rename-command {{ item }} "{{ item|hash("md5") }}"'
  loop: '{{ redis_renamed_commands }}'
  register: comm_update

- name: Configure kernel parameters
  sysctl:
    name: '{{ item.variable }}'
    value: '{{ item.value }}'
    state: 'present'
    reload: 'yes'
    sysctl_set: 'yes'
    sysctl_file: /etc/sysctl.d/20-sysctl.conf
  loop: '{{ redis_kernel_parameters }}'

- name: Reload the Redis configuration
  systemd:
    name: 'redis.service'
    enabled: 'yes'
    state: 'restarted'
    daemon_reload: 'yes'
  when:
    - conf_update is changed or comm_update is changed
    - ansible_distribution_major_version|int > 6

- name: Include prometheus exporter tasks
  include: 'exporter.yml'
  when: exporter_is_install | bool

- name: Registered with HashiCorp Consul
  include: 'register.yml'
  when:
    - exporter_is_install | bool
    - consul_public_register | bool
