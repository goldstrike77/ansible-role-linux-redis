---
- name: Include OS-specific variables
  include_vars: '{{ ansible_os_family }}.yml'

- name: Include tasks for specific OS
  include: '{{ ansible_os_family }}.yml'

- name: Straight to getenforce selinux status
  include: selinux.yml

- name: Creating Redis folder
  file:
    dest: '{{ redis_path }}/redis'
    state: directory
    owner: redis
    group: redis
    mode: 0755

- name: Redis Server Configuration
  lineinfile:
    state: present
    dest: /etc/redis.conf
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  with_items:
    - { regexp: '^bind ', line: 'bind 0.0.0.0' }
    - { regexp: '^tcp-backlog ', line: 'tcp-backlog {{ redis_tcp_backlog }}' }
    - { regexp: '^timeout ', line: 'timeout {{ redis_timeout }}' }
    - { regexp: '^tcp-keepalive ', line: 'tcp-keepalive {{ redis_tcp_keepalive }}' }
    - { regexp: '^daemonize ', line: 'daemonize yes' }
    - { regexp: '^supervised ', line: 'supervised systemd' }
    - { regexp: '^dir /', line: 'dir {{ redis_path }}/redis' }
    - { regexp: '^maxclients ', line: 'maxclients {{ redis_maxclients }}' }
    - { regexp: '^maxmemory ', line: 'maxmemory {% if ansible_memtotal_mb < 4095 %}{{ (ansible_memtotal_mb * 0.5)|int }}mb{% else %}{{ (ansible_memtotal_mb * 0.85)|int }}mb{% endif %}' }
    - { regexp: '^appendonly ', line: 'appendonly yes' }
    - { regexp: '^syslog-enabled ', line: 'syslog-enabled yes' }
  register: conf_update

- name: Rename an unsafe redis command
  lineinfile:
    state: present
    dest: /etc/redis.conf
    regexp: '^rename-command {{ item }}'
    line: 'rename-command {{ item }} "{{ item|hash("md5") }}"'
  with_items:
    - '{{ redis_renamed_commands }}'
  register: comm_update

- name: Configure kernel parameters
  sysctl:
    name: '{{ item.variable }}'
    value: '{{ item.value }}'
    state: present
    reload: yes
    sysctl_set: yes
    sysctl_file: /etc/sysctl.d/20-sysctl.conf
  with_items:
    - { variable: 'vm.overcommit_memory', value: '1' }

- name: Reload the Redis configuration
  systemd:
    name: 'redis.service'
    enabled: yes
    state: restarted
    daemon_reload: yes
  when:
    - conf_update.changed or comm_update.changed
    - ansible_distribution_major_version|int > 6

- include: 'redis_exporter.yml'
